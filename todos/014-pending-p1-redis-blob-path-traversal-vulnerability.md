# Redis Blob Storage Path Traversal Vulnerability

**Date:** 2026-01-11
**Status:** pending
**Priority:** P1 - Critical
**Tags:** code-review, security, dotnet, redis, blobs

---

## Problem Statement

`_NormalizePath` (line 605) only converts backslashes to forward slashes but does NOT prevent path traversal sequences like `../`.

```csharp
private static string? _NormalizePath(string? path) => path?.Replace('\\', '/');

private static string _BuildBlobPath(string[] container, string blobName)
{
    if (container.Length == 1)
    {
        return blobName;  // blobName passed directly without sanitization!
    }
    return _NormalizePath(string.Join('/', container.Skip(1)).EnsureEndsWith('/') + blobName);
}
```

**Attack Vector:**
A malicious `blobName` like `../../other-container/sensitive-file` could escape the intended container boundary and access/overwrite blobs in other containers.

---

## Findings

**From security-sentinel:**
- `blobName` is passed directly without sanitization
- Container array elements are also not validated for `..`
- URL-encoded variants (`..%2F`) may also bypass

**Severity:** MEDIUM (Redis keys are just strings, so impact is container escape, not filesystem access)

---

## Proposed Solutions

### Option A: Reject Path Traversal Sequences
```csharp
private static void _ValidateBlobName(string blobName)
{
    if (blobName.Contains("..", StringComparison.Ordinal))
        throw new ArgumentException("Blob name cannot contain '..'", nameof(blobName));
    if (blobName.StartsWith('/') || blobName.StartsWith('\\'))
        throw new ArgumentException("Blob name cannot start with path separator", nameof(blobName));
}
```
- **Pros:** Simple, explicit
- **Cons:** May reject legitimate file names with ".." (rare)
- **Effort:** Small
- **Risk:** Low

### Option B: Normalize and Resolve Path
```csharp
var normalized = Path.GetFullPath(blobName).Replace('\\', '/');
if (normalized.Contains("..")) throw new ArgumentException(...);
```
- **Pros:** Handles all path tricks
- **Cons:** Platform-dependent behavior
- **Effort:** Small
- **Risk:** Low

### Option C: Allowlist Characters
```csharp
private static readonly Regex _ValidBlobName = new(@"^[a-zA-Z0-9_\-./]+$");
```
- **Pros:** Most restrictive, safest
- **Cons:** May break existing blob names with special chars
- **Effort:** Small
- **Risk:** Medium (breaking change potential)

---

## Recommended Action

**Option A** - Reject `..` sequences explicitly. Simple and effective.

---

## Technical Details

**Affected Files:**
- `src/Framework.Blobs.Redis/RedisBlobStorage.cs` (lines 594-606)

**Affected Methods:**
- `_BuildBlobPath`
- `_NormalizePath`
- All public methods that accept `blobName` parameter

---

## Acceptance Criteria

- [ ] Add validation to reject `..` in blob names
- [ ] Add validation to reject `..` in container segments
- [ ] Add unit tests for path traversal attempts
- [ ] Document allowed characters for blob names

---

## Work Log

| Date | Action | Notes |
|------|--------|-------|
| 2026-01-11 | Created | From code review - security-sentinel |
