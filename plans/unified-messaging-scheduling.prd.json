{
	"name": "unified-messaging-scheduling",
	"description": "Merge Ticker scheduling into Messaging system - Phase 1 (abstractions) + Phase 2 (infrastructure)",
	"created_at": "2026-02-05T00:00:00Z",
	"status": "in_progress",
	"branches": {
		"base": "main",
		"feature": "xshaheen/unified-messaging-scheduling"
	},
	"worktree": "../.swarm-worktrees/unified-messaging-scheduling",
	"userStories": [
		{
			"id": "US-001",
			"title": "Create ScheduledTrigger message type",
			"size": "S",
			"priority": 1,
			"pass": true,
			"attempts": 0,
			"commits": ["594c2d83"],
			"notes": "ScheduledTrigger sealed record in Headless.Messaging.Abstractions/ScheduledTrigger.cs. Root of project, not Messages/ subfolder. Payload is string? (opaque).",
			"description": "Create ScheduledTrigger sealed record in Headless.Messaging.Abstractions. Replaces TickerFunctionContext. Properties: ScheduledTime (DateTimeOffset, required), JobName (string, required), Attempt (int, required), CronExpression (string?), ParentJobId (Guid?), Payload (string?). File-scoped namespace Headless.Messaging. XML docs on all members.",
			"filesToStudy": [
				"src/Headless.Messaging.Abstractions/IConsume.cs",
				"src/Headless.Messaging.Abstractions/ConsumeContext.cs",
				"src/Headless.Ticker.Abstractions/Base/TickerFunctionContext.cs",
				"src/Headless.Messaging.Abstractions/Headless.Messaging.Abstractions.csproj",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"ScheduledTrigger sealed record with required properties: ScheduledTime (DateTimeOffset), JobName (string), Attempt (int)",
				"Optional properties: CronExpression (string?), ParentJobId (Guid?), Payload (string?)",
				"XML documentation on all members",
				"File-scoped namespace Headless.Messaging, sealed record"
			]
		},
		{
			"id": "US-002",
			"title": "Create RecurringAttribute",
			"size": "S",
			"priority": 2,
			"pass": true,
			"attempts": 0,
			"commits": ["5b8bd89e"],
			"notes": "RecurringAttribute in Headless.Messaging.Abstractions/RecurringAttribute.cs. Traditional constructor (not primary) because Attribute subclasses. CronExpression getter-only, others get/set for named attribute syntax. SkipIfRunning defaults true.",
			"description": "Create [Recurring] attribute in Headless.Messaging.Abstractions targeting AttributeTargets.Class. Constructor takes string cronExpression (6-field format). Properties: Name (string?), TimeZone (string?, null=UTC), RetryIntervals (int[]?), SkipIfRunning (bool, default true). XML docs. Sealed class.",
			"filesToStudy": [
				"src/Headless.Ticker.Abstractions/Base/TickerFunctionAttribute.cs",
				"src/Headless.Messaging.Abstractions/Headless.Messaging.Abstractions.csproj",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"Sealed class targeting AttributeTargets.Class with constructor taking string cronExpression",
				"Properties: Name (string?), TimeZone (string?), RetryIntervals (int[]?), SkipIfRunning (bool default true)",
				"XML documentation on class and all members",
				"File-scoped namespace Headless.Messaging"
			]
		},
		{
			"id": "US-003",
			"title": "Unit tests for scheduling types",
			"size": "S",
			"priority": 3,
			"pass": true,
			"attempts": 0,
			"commits": ["8b44994e"],
			"notes": "Used existing test project (144 total tests now). 25 new tests: 11 for ScheduledTrigger, 14 for RecurringAttribute. All passing.",
			"description": "Unit tests for ScheduledTrigger and RecurringAttribute in Headless.Messaging.Abstractions.Tests.Unit (create project if needed). TestBase inheritance, AbortToken, AwesomeAssertions. Verify required/optional properties, attribute constructor, defaults, AttributeUsage. should_*_when_* naming.",
			"filesToStudy": [
				"tests/Headless.Messaging.Abstractions.Tests.Unit/",
				"tests/Headless.Messaging.Core.Tests.Unit/",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"Tests in Headless.Messaging.Abstractions.Tests.Unit project",
				"TestBase inheritance, AbortToken, AwesomeAssertions",
				"Verify ScheduledTrigger required vs optional properties",
				"Verify RecurringAttribute constructor, defaults, AttributeUsage",
				"should_*_when_* naming convention, all tests pass"
			]
		},
		{
			"id": "US-004",
			"title": "Create scheduling entity types and enums",
			"size": "M",
			"priority": 4,
			"pass": true,
			"attempts": 0,
			"commits": ["15f0eaa9"],
			"notes": "Entities in Scheduling/ subfolder: ScheduledJob.cs, JobExecution.cs, 3 enums. All mutable classes (get;set;) with required modifier. Namespace Headless.Messaging (not sub-namespace).",
			"description": "Define ScheduledJob entity, JobExecution entity, and enums (ScheduledJobStatus, JobExecutionStatus, ScheduledJobType) in Headless.Messaging.Abstractions. Follow existing entity patterns from Ticker. All sealed, required/init properties, XML docs.",
			"filesToStudy": [
				"src/Headless.Ticker.Abstractions/Entities/CronTickerEntity.cs",
				"src/Headless.Ticker.Abstractions/Entities/CronTickerOccurrenceEntity.cs",
				"src/Headless.Messaging.Abstractions/Headless.Messaging.Abstractions.csproj",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"ScheduledJob entity with all properties per plan schema (Id, Name, Type, CronExpression, TimeZone, Payload, Status, NextRunTime, LastRunTime, LastRunDuration, RetryCount, RetryIntervals, SkipIfRunning, LockHolder, LockedAt, IsEnabled, DateCreated, DateUpdated)",
				"JobExecution entity (Id, JobId, ScheduledTime, StartedAt, CompletedAt, Status, Duration, RetryAttempt, Error)",
				"Enums: ScheduledJobStatus (Pending/Running/Completed/Failed/Disabled), JobExecutionStatus (Pending/Running/Succeeded/Failed), ScheduledJobType (Recurring/OneTime)",
				"All in namespace Headless.Messaging, sealed classes, required/init properties, XML docs"
			]
		},
		{
			"id": "US-005",
			"title": "Create IScheduledJobStorage abstraction",
			"size": "M",
			"priority": 5,
			"pass": true,
			"attempts": 0,
			"commits": ["d61b355e"],
			"notes": "IScheduledJobStorage in Scheduling/IScheduledJobStorage.cs. IReadOnlyList returns, Task (not ValueTask), CancellationToken defaults to default. AcquireDueJobsAsync(batchSize, lockHolder, ct) for atomic pickup.",
			"description": "Define IScheduledJobStorage interface in Headless.Messaging.Abstractions. Methods: AcquireDueJobsAsync, GetJobByNameAsync, GetAllJobsAsync, UpsertJobAsync, UpdateJobAsync, DeleteJobAsync, CreateExecutionAsync, UpdateExecutionAsync, GetExecutionsAsync. AcquireDueJobsAsync atomically marks jobs as Running. XML docs on all methods. CancellationToken on all async.",
			"filesToStudy": [
				"src/Headless.Ticker.Abstractions/Interfaces/ITickerPersistenceProvider.cs",
				"src/Headless.Messaging.Core/Persistence/IDataStorage.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"IScheduledJobStorage interface with: AcquireDueJobsAsync, GetJobByNameAsync, GetAllJobsAsync, UpsertJobAsync, UpdateJobAsync, DeleteJobAsync, CreateExecutionAsync, UpdateExecutionAsync, GetExecutionsAsync",
				"AcquireDueJobsAsync atomically marks jobs as Running with LockHolder to prevent double-pickup",
				"CancellationToken on all async methods",
				"XML documentation on all methods"
			]
		},
		{
			"id": "US-006",
			"title": "Port CronScheduleCache from Ticker",
			"size": "S",
			"priority": 6,
			"pass": true,
			"attempts": 0,
			"commits": ["a75149c3"],
			"notes": "CronScheduleCache in Scheduling/CronScheduleCache.cs. Instance-based (not static). Uses Cronos 0.11.1. Returns DateTimeOffset?. Internal sealed. Not yet DI-registered -- register as singleton downstream.",
			"description": "Port cron parsing + caching from Ticker to Headless.Messaging.Core as internal CronScheduleCache. Uses Cronos library for 6-field cron parsing. Thread-safe ConcurrentDictionary<string, CronExpression> cache. Method: GetNextOccurrence(cron, timeZone, from). Add Cronos to Directory.Packages.props. Unit tests.",
			"filesToStudy": [
				"src/Headless.Ticker.Core/",
				"src/Headless.Messaging.Core/Headless.Messaging.Core.csproj",
				"Directory.Packages.props",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"CronScheduleCache sealed internal class in Headless.Messaging.Core",
				"Uses Cronos library for 6-field cron parsing (seconds support)",
				"GetNextOccurrence(string cron, string timeZone, DateTimeOffset from) method",
				"Thread-safe ConcurrentDictionary caching",
				"Cronos package in Directory.Packages.props",
				"Unit tests for caching, timezone, next-occurrence calculation"
			]
		},
		{
			"id": "US-007",
			"title": "Create PostgreSQL scheduled_jobs + job_executions schema",
			"size": "M",
			"priority": 7,
			"pass": true,
			"attempts": 0,
			"commits": ["7ca70c08"],
			"notes": "EF Core configs in Configurations/ subfolder. DDL added to PostgreSqlStorageInitializer. IStorageInitializer extended with GetScheduledJobsTableName/GetJobExecutionsTableName.",
			"description": "EF Core entity configurations for ScheduledJob and JobExecution in Headless.Messaging.PostgreSql. Table names: scheduled_jobs, job_executions. Partial indexes for PostgreSQL. Unique constraint on Name. FK with CASCADE. Integrate with existing PostgreSQL storage registration.",
			"filesToStudy": [
				"src/Headless.Messaging.PostgreSql/",
				"src/Headless.Ticker.EntityFramework/Infrastructure/",
				"docs/ideas/Unified-messaging-system-plan.md",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"IEntityTypeConfiguration<ScheduledJob> and IEntityTypeConfiguration<JobExecution> in PostgreSQL provider",
				"Table names: scheduled_jobs, job_executions with proper column mappings",
				"Partial indexes: idx_jobs_next_run (WHERE Pending+Enabled), idx_jobs_lock (WHERE Running)",
				"Unique constraint on scheduled_jobs.Name",
				"FK: job_executions.JobId -> scheduled_jobs.Id CASCADE",
				"Integration with existing PostgreSQL messaging storage registration path"
			]
		},
		{
			"id": "US-008",
			"title": "Implement PostgreSqlScheduledJobStorage",
			"size": "L",
			"priority": 8,
			"pass": true,
			"attempts": 0,
			"commits": ["b2440a39"],
			"notes": "Raw SQL with NpgsqlParameter. CTE-based SELECT FOR UPDATE SKIP LOCKED. Upsert via ON CONFLICT. TimeProvider for testability.",
			"description": "Implement IScheduledJobStorage for PostgreSQL. AcquireDueJobsAsync uses SELECT FOR UPDATE SKIP LOCKED. All CRUD methods. UpsertJobAsync for reconciliation (insert or update by name). Primary constructor, sealed, ConfigureAwait(false), CancellationToken propagation.",
			"filesToStudy": [
				"src/Headless.Messaging.PostgreSql/PostgreSqlDataStorage.cs",
				"src/Headless.Ticker.EntityFramework/Infrastructure/BasePersistenceProvider.cs",
				"src/Headless.Messaging.Abstractions/Scheduling/IScheduledJobStorage.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"PostgreSqlScheduledJobStorage sealed class implements IScheduledJobStorage",
				"AcquireDueJobsAsync uses SELECT FOR UPDATE SKIP LOCKED",
				"UpsertJobAsync handles reconciliation (insert or update by name)",
				"All CRUD methods implemented with proper error handling",
				"Primary constructor, ConfigureAwait(false), CancellationToken propagation"
			]
		},
		{
			"id": "US-009",
			"title": "Create IScheduledJobDispatcher",
			"size": "M",
			"priority": 9,
			"pass": true,
			"attempts": 0,
			"commits": ["fc712987"],
			"notes": "Internal interface + sealed impl in Scheduling/ subfolder. Keyed DI resolution. ConsumeContext mapping. IConsumeFilter hooks. Scoped dispatch.",
			"description": "Dedicated dispatcher that resolves IConsume<ScheduledTrigger> handlers by job name using keyed DI. Creates ConsumeContext with execution ID as MessageId, job name as Topic. Creates DI scope per dispatch. Fires IConsumeFilter hooks for observability. Internal sealed class.",
			"filesToStudy": [
				"src/Headless.Messaging.Core/Internal/CompiledMessageDispatcher.cs",
				"src/Headless.Messaging.Abstractions/ConsumeContext.cs",
				"src/Headless.Messaging.Abstractions/IConsumeFilter.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"IScheduledJobDispatcher interface with DispatchAsync(ScheduledJob job, JobExecution execution, CancellationToken)",
				"Implementation resolves handler via GetRequiredKeyedService<IConsume<ScheduledTrigger>>(jobName)",
				"Creates ConsumeContext: MessageId=executionId, Topic=jobName, Timestamp=scheduledTime, CorrelationId=null, Headers=empty",
				"Creates DI scope per dispatch (await using)",
				"Fires IConsumeFilter hooks if registered"
			]
		},
		{
			"id": "US-010",
			"title": "Create SchedulerBackgroundService",
			"size": "L",
			"priority": 10,
			"pass": true,
			"attempts": 0,
			"commits": ["1e0e01b0"],
			"notes": "Polling loop with configurable interval/batch. Retry with intervals. Recurring jobs recompute NextRunTime. OneTime jobs complete. SchedulerOptions for config.",
			"description": "Main scheduler loop. Extends BackgroundService. Polls IScheduledJobStorage.AcquireDueJobsAsync at configurable interval (default 1s). For each job: dispatches via IScheduledJobDispatcher, records execution, computes NextRunTime via CronScheduleCache. Handles failures with retry. Graceful shutdown. Only starts if IScheduledJobStorage registered.",
			"filesToStudy": [
				"src/Headless.Ticker.Core/",
				"src/Headless.Messaging.Core/Processor/",
				"src/Headless.Messaging.Core/Setup.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"Extends BackgroundService, polls at configurable interval (default 1s)",
				"Dispatches via IScheduledJobDispatcher, records execution results",
				"Computes NextRunTime via CronScheduleCache after each execution",
				"Handles failures: logs, increments RetryCount, applies RetryIntervals",
				"Graceful shutdown: completes in-flight jobs on cancellation",
				"Only starts if IScheduledJobStorage is registered in DI"
			]
		},
		{
			"id": "US-011",
			"title": "Create IScheduledJobManager",
			"size": "M",
			"priority": 11,
			"pass": true,
			"attempts": 0,
			"commits": ["de5e3fd1"],
			"notes": "Interface in Abstractions, impl in Core. Enable/disable recomputes NextRunTime. TriggerAsync sets immediate execution. Argument guards.",
			"description": "Public API for runtime job management. IScheduledJobManager interface in Abstractions: GetAllAsync, GetByNameAsync, EnableAsync, DisableAsync, TriggerAsync (manual run), DeleteAsync. ScheduledJobManager sealed implementation in Core. TriggerAsync creates immediate execution. Enable/Disable updates status + recomputes NextRunTime. XML docs.",
			"filesToStudy": [
				"src/Headless.Ticker.Abstractions/Interfaces/Managers/ICronTickerManager.cs",
				"src/Headless.Ticker.Abstractions/Managers/TickerManager.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"IScheduledJobManager interface in Abstractions with GetAllAsync, GetByNameAsync, EnableAsync, DisableAsync, TriggerAsync, DeleteAsync",
				"ScheduledJobManager sealed implementation in Core using IScheduledJobStorage",
				"TriggerAsync creates immediate execution bypassing cron schedule",
				"EnableAsync/DisableAsync update status and recompute NextRunTime",
				"XML documentation on interface methods"
			]
		},
		{
			"id": "US-012",
			"title": "Integrate scheduler with AddMessages builder",
			"size": "M",
			"priority": 12,
			"pass": true,
			"attempts": 0,
			"commits": ["90e3b865"],
			"notes": "ScanConsumers detects [Recurring], registers keyed DI, skips transport subscription. WithSchedule/WithTimeZone fluent API. SchedulerJobReconciler for startup reconciliation. ScheduledJobDefinitionRegistry collects definitions.",
			"description": "Wire scheduling into AddMessages(). ScanConsumers detects [Recurring] on IConsume<ScheduledTrigger> -> registers as keyed DI services (name = attribute Name ?? class name) -> does NOT create transport subscription. Fluent WithSchedule/WithTimeZone on IConsumerBuilder. Register SchedulerBackgroundService, IScheduledJobManager, IScheduledJobDispatcher. On startup: reconcile jobs with DB (upsert new, update changed, soft-disable removed).",
			"filesToStudy": [
				"src/Headless.Messaging.Core/Setup.cs",
				"src/Headless.Messaging.Abstractions/IMessagingBuilder.cs",
				"src/Headless.Messaging.Abstractions/IConsumerBuilder.cs",
				"src/Headless.Messaging.Core/Internal/ConsumerRegistry.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"ScanConsumers detects [Recurring] on IConsume<ScheduledTrigger>, registers as keyed DI, skips transport subscription",
				"Fluent WithSchedule(cron) and WithTimeZone(iana) on IConsumerBuilder<T>",
				"SchedulerBackgroundService, IScheduledJobManager, IScheduledJobDispatcher registered in DI",
				"Startup reconciliation: upsert new jobs, update changed cron, soft-disable removed jobs",
				"Scheduler only registered if IScheduledJobStorage is present"
			]
		},
		{
			"id": "US-013",
			"title": "Add optional distributed locking",
			"size": "M",
			"priority": 13,
			"pass": true,
			"attempts": 0,
			"commits": ["c92715cb"],
			"notes": "Optional IDistributedLockProvider resolved from DI. SkipIfRunning uses TryAcquireAsync with zero timeout. Lock released in finally. LockTimeout in SchedulerOptions.",
			"description": "Integrate IResourceLockProvider for additional distributed lock layer. If registered: acquire messaging:job:{name} lock before execution. If not: rely on DB SELECT FOR UPDATE SKIP LOCKED. SkipIfRunning=true skips if lock unavailable. Lock released after execution. Configurable timeout (default 5 min).",
			"filesToStudy": [
				"src/Headless.DistributedLocks.Abstractions/",
				"src/Headless.DistributedLocks.Core/RegularLocks/ResourceLockProvider.cs",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"If IResourceLockProvider registered: acquire messaging:job:{name} lock before execution",
				"If not registered: rely on database SELECT FOR UPDATE SKIP LOCKED",
				"SkipIfRunning=true jobs skipped if lock unavailable",
				"Lock released after execution (even on failure)",
				"Configurable lock timeout (default 5 minutes)"
			]
		},
		{
			"id": "US-014",
			"title": "Unit tests for scheduler components",
			"size": "L",
			"priority": 14,
			"pass": true,
			"attempts": 0,
			"commits": ["4deb91ed"],
			"notes": "45 tests: SchedulerBackgroundService, ScheduledJobManager, ScheduledJobDispatcher, CronScheduleCache, SchedulerJobReconciler. All passing.",
			"description": "Comprehensive unit tests: SchedulerBackgroundService (polling, dispatch, failures, shutdown), ScheduledJobManager (CRUD, enable/disable, trigger), ScheduledJobDispatcher (keyed resolution, scope, filters), CronScheduleCache (parsing, timezone, DST), job discovery in ScanConsumers, startup reconciliation. NSubstitute, TestBase, AbortToken.",
			"filesToStudy": [
				"tests/Headless.Messaging.Core.Tests.Unit/",
				"tests/Headless.Ticker.Tests.Unit/",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"Tests for SchedulerBackgroundService: polling, dispatch, failure handling, graceful shutdown",
				"Tests for ScheduledJobManager: CRUD, enable/disable, manual trigger",
				"Tests for ScheduledJobDispatcher: keyed DI resolution, scope creation, filter invocation",
				"Tests for CronScheduleCache: parsing, caching, timezone, DST edge cases",
				"Tests for job discovery and startup reconciliation",
				"NSubstitute mocks, TestBase, AbortToken, should_*_when_* naming"
			]
		},
		{
			"id": "US-015",
			"title": "Integration tests with PostgreSQL",
			"size": "M",
			"priority": 15,
			"pass": true,
			"attempts": 0,
			"commits": ["2f620874"],
			"notes": "PostgreSQL Testcontainers integration tests for scheduled job storage. CRUD, acquisition, upsert, cascade delete, execution tracking.",
			"description": "Testcontainers PostgreSQL integration tests. End-to-end: seed job -> scheduler picks up -> handler executes -> execution recorded. Concurrent acquisition (no double-execute). Enable/disable, manual trigger, startup reconciliation.",
			"filesToStudy": [
				"tests/Headless.Messaging.PostgreSql.Tests.Integration/",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"Testcontainers PostgreSQL setup",
				"E2E test: seed recurring job -> scheduler dispatches -> handler executes -> execution recorded in DB",
				"Concurrent acquisition test: two instances don't double-execute",
				"Enable/disable and manual trigger tests",
				"Job reconciliation on startup test",
				"TestBase, AbortToken, all tests pass with Docker"
			]
		},
		{
			"id": "US-016",
			"title": "Update README files",
			"size": "S",
			"priority": 16,
			"pass": true,
			"attempts": 0,
			"commits": ["7d162c53"],
			"notes": "Abstractions and Core READMEs updated with scheduling sections, code examples, configuration docs.",
			"description": "Update README.md for Headless.Messaging.Abstractions and Headless.Messaging.Core to document scheduling capabilities. Examples for [Recurring] attribute, fluent API, IConsume<ScheduledTrigger> handler, IScheduledJobManager.",
			"filesToStudy": [
				"src/Headless.Messaging.Abstractions/README.md",
				"src/Headless.Messaging.Core/README.md",
				"CLAUDE.md"
			],
			"acceptanceCriteria": [
				"Abstractions README documents ScheduledTrigger, [Recurring], IScheduledJobManager, IScheduledJobStorage",
				"Core README documents scheduler setup, polling config, retry behavior",
				"Code examples for attribute-based and fluent job registration",
				"Example IConsume<ScheduledTrigger> handler implementation"
			]
		}
	],
	"pass": true,
	"validation_errors": []
}
