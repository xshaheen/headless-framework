{
	"name": "job-execution-correlation",
	"description": "Automatic correlation chain from scheduled job execution to messages published by job handlers via AsyncLocal ambient context",
	"created_at": "2026-02-07T00:00:00Z",
	"status": "pending",
	"branches": {
		"base": "main",
		"feature": "xshaheen/unified-messaging-scheduling"
	},
	"worktree": null,
	"userStories": [
		{
			"id": "US-006",
			"title": "Create MessagingCorrelationScope",
			"size": "S",
			"priority": 1,
			"pass": false,
			"attempts": 0,
			"commits": [],
			"notes": "Full Merge US-030 depends on this (consumer correlation sets scope in CompiledMessageDispatcher)",
			"description": "AsyncLocal-based ambient correlation context in Headless.Messaging.Abstractions. Sealed class with static Current, Begin() factory, IDisposable, CorrelationId (string), _sequence (int field for Interlocked.Increment), nesting-safe via parent restore. Chosen over MassTransit's scoped DI approach because publishers aren't resolved from dispatcher scope. Chosen over Ticker's ParentId entity model because we need correlation propagation, not execution trees.",
			"filesToStudy": [
				"src/Headless.Messaging.Core/Internal/OutboxPublisher.cs",
				"src/Headless.Messaging.Core/Transactions/OutboxTransaction.cs",
				"src/Headless.Messaging.Abstractions/Messages/Headers.cs"
			],
			"acceptanceCriteria": [
				"MessagingCorrelationScope sealed class in Headless.Messaging namespace (Abstractions)",
				"AsyncLocal<MessagingCorrelationScope?> for ambient context with static Current property",
				"Begin() factory, IDisposable for cleanup, nesting-safe via parent scope restore",
				"CorrelationId (string) and _sequence (private int field) with Interlocked.Increment",
				"XML docs"
			]
		},
		{
			"id": "US-007",
			"title": "Populate correlation in ScheduledJobDispatcher",
			"size": "S",
			"priority": 2,
			"pass": false,
			"attempts": 0,
			"commits": [],
			"notes": "",
			"description": "Set CorrelationId = execution.Id (was null), populate headers with correlation metadata, wrap handler invocation in MessagingCorrelationScope.Begin(). Scope disposed in finally.",
			"filesToStudy": [
				"src/Headless.Messaging.Core/Scheduling/ScheduledJobDispatcher.cs",
				"src/Headless.Messaging.Abstractions/Messages/Headers.cs"
			],
			"acceptanceCriteria": [
				"CorrelationId = execution.Id.ToString() instead of null",
				"Headers populated: headless-corr-id = execution ID, headless-corr-seq = 0",
				"using MessagingCorrelationScope.Begin() wrapping handler invocation",
				"Scope disposed in finally block even on handler failure"
			]
		},
		{
			"id": "US-008",
			"title": "Make publishers read MessagingCorrelationScope",
			"size": "M",
			"priority": 3,
			"pass": false,
			"attempts": 0,
			"commits": [],
			"notes": "",
			"description": "OutboxPublisher and DirectPublisher auto-inherit correlation from ambient MessagingCorrelationScope when CorrelationId not in explicit headers. Explicit headers always win. Backward compatible.",
			"filesToStudy": [
				"src/Headless.Messaging.Core/Internal/OutboxPublisher.cs",
				"src/Headless.Messaging.Core/Internal/DirectPublisher.cs"
			],
			"acceptanceCriteria": [
				"Both publishers check MessagingCorrelationScope.Current when CorrelationId not in headers",
				"If scope exists: use scope.CorrelationId, CorrelationSequence = scope.IncrementSequence()",
				"If scope null: existing behavior (CorrelationId = MessageId, sequence = 0)",
				"Explicit headers always override ambient scope",
				"No behavior change when no scope active (backward compatible)"
			]
		},
		{
			"id": "US-009",
			"title": "Unit tests for correlation propagation",
			"size": "M",
			"priority": 4,
			"pass": false,
			"attempts": 0,
			"commits": [],
			"notes": "",
			"description": "Tests for MessagingCorrelationScope lifecycle, ScheduledJobDispatcher correlation setting, OutboxPublisher/DirectPublisher ambient inheritance, explicit header override, backward compatibility.",
			"filesToStudy": [
				"tests/Headless.Messaging.Core.Tests.Unit/",
				"tests/Headless.Messaging.Abstractions.Tests.Unit/"
			],
			"acceptanceCriteria": [
				"MessagingCorrelationScope: begin/dispose, nesting, thread-safe sequence",
				"ScheduledJobDispatcher: sets CorrelationId, populates headers, begins scope",
				"Publishers: inherit correlation from scope, explicit headers override, no scope = existing behavior",
				"TestBase, AbortToken, should_*_when_* naming"
			]
		},
		{
			"id": "US-010",
			"title": "Update README",
			"size": "XS",
			"priority": 5,
			"pass": false,
			"attempts": 0,
			"commits": [],
			"notes": "",
			"description": "Document automatic job-to-message correlation in Core README. Example showing handler publishing message with automatic correlation.",
			"filesToStudy": ["src/Headless.Messaging.Core/README.md"],
			"acceptanceCriteria": [
				"Document automatic job-to-message correlation propagation",
				"Example: scheduled job handler publishing message with auto-correlation"
			]
		}
	],
	"pass": false,
	"validation_errors": []
}
